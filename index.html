<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Dijital Menü</title>
  <!-- Swiper CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    /* --- Global Styles --- */
    html {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif; /* Basic, readable font */
      background-color: black; /* Fallback background */
      box-sizing: border-box; /* Easier layout calculations */
    }
    *, *:before, *:after {
      box-sizing: inherit;
    }

    body {
      margin: 0;
      /* Add padding-bottom to prevent content from hiding behind fixed elements */
      padding: 0 0 200px 0; /* Adjusted padding for gallery + legend */
      background-color: transparent; /* Show video background */
      color: white; /* Default text color */
      min-height: 100vh;
      position: relative; /* Needed for absolute/fixed children context if required */
    }

    /* --- Video Background --- */
    #video-bg {
      position: fixed;
      top: 0;
      left: 0;
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      z-index: -1; /* Behind everything else */
      opacity: 0.3; /* Make it subtle */
      object-fit: cover; /* Cover the screen without distortion */
    }

    /* --- Menu Layout --- */
    #menu {
      padding: 2rem; /* Spacing around the menu */
      border-radius: 12px; /* Optional rounded corners */
      margin: 2rem auto; /* Center menu horizontally, provide top/bottom margin */
      display: flex;
      gap: 2.5rem; /* Space between columns */
      flex-wrap: wrap; /* Allow columns to wrap on smaller screens */
      justify-content: center; /* Center columns if they don't fill the width */
      max-width: 1600px; /* Limit maximum width for very large screens */
    }

    .column {
      flex: 1; /* Allow columns to grow */
      min-width: 320px; /* Minimum width before wrapping - adjusted for price columns */
      max-width: 480px; /* Maximum width per column - adjusted */
    }

    /* --- Category & Items --- */
    .kategori-baslik {
      font-size: 1.9rem; /* Larger category title */
      font-weight: bold;
      margin-bottom: 1rem; /* Space below title */
      color: orange;
      text-align: center;
      border-bottom: 2px solid orange;
      padding-bottom: 0.5rem; /* Space between text and border */
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7); /* Enhanced text shadow */
    }

    .header-row {
      display: grid;
      /* Adjust columns: Auto for name, fixed for THC, TWO fixed for Prices */
      grid-template-columns: auto 60px 65px 65px; /* *** CHANGED: Split price column *** */
      gap: 10px; /* Space between header columns */
      font-size: 0.9rem;
      font-weight: bold;
      margin-bottom: 0.8rem; /* Space below header */
      border-bottom: 1px solid rgba(255, 255, 255, 0.4); /* Lighter border */
      padding-bottom: 0.4rem;
      align-items: center;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
    }
    /* Center align THC and Price headers */
    .header-row span:nth-child(2),
    .header-row span:nth-child(3),
    .header-row span:nth-child(4) { /* *** CHANGED: Added 4th child *** */
      text-align: center;
    }

    .urun {
      display: grid;
      /* Match header columns */
      grid-template-columns: auto 60px 65px 65px; /* *** CHANGED: Split price column *** */
      gap: 10px; /* Space between item columns */
      align-items: center; /* Vertically align content */
      margin-bottom: 0.6rem; /* Space between items */
      font-size: 1.1rem; /* Slightly larger item text */
      text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8); /* Stronger shadow */
      min-height: 30px; /* Ensure consistent row height */
    }
    /* Allow long product names to wrap */
    .urun span:first-child {
      word-break: break-word;
      line-height: 1.3; /* Improve readability for wrapped text */
    }
     /* Center align price columns */
    .urun span:nth-child(3),
    .urun span:nth-child(4) { /* *** CHANGED: Added 4th child *** */
        text-align: center;
        font-size: 1rem; /* Match previous single price size */
        white-space: nowrap; /* Prevent wrapping */
    }


    /* --- Item Status Styling --- */
    /* Out of Stock */
    .cizili {
      text-decoration: line-through;
      color: #888 !important; /* Use important to override potential inline styles */
      text-shadow: none !important;
      opacity: 0.7; /* Make it faded */
    }
    .cizili span { /* Ensure child spans also get styled */
      color: inherit !important;
      text-decoration: inherit;
      text-shadow: inherit !important;
    }
     .cizili .thc-orani { /* Keep THC color distinct but faded */
       color: #007777 !important; /* Dimmed cyan */
     }

    /* New Item Indicator */
    .new span:first-child::after {
      content: "";
      display: inline-block;
      background-image: url('New-Icon.png'); /* Ensure this path is correct */
      background-size: contain;
      background-repeat: no-repeat;
      width: 30px; /* Adjust size as needed */
      height: 20px; /* Adjust size as needed */
      margin-left: 8px; /* Space from text */
      vertical-align: middle; /* Align with text */
      filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.6)); /* Add shadow to icon */
    }

    /* --- Specific Item Details --- */
    .thc-orani {
      color: #00FFFF; /* Cyan for THC */
      font-size: 1rem;
      text-align: center;
      white-space: nowrap; /* Prevent wrapping */
    }

    /* Price alignment - now handled by .urun span:nth-child(3/4) */
    /* .urun span:last-child - NO LONGER NEEDED for price alignment */

    /* Message for empty categories */
    .yakinda-mesaji {
        text-align: center;
        padding: 1.5rem 0;
        font-size: 1rem;
        color: #aaa;
        font-style: italic;
    }

    /* --- Bottom Gallery --- */
    #bottom-gallery {
      position: fixed;
      bottom: 0px; /* Sit right at the bottom */
      left: 0; /* Start from left edge */
      width: 100%; /* Full width */
      height: 180px; /* Increased height */
      z-index: 5; /* Above video, below legend/logo potentially */
      overflow: hidden;
      padding: 10px 0; /* Vertical padding */
      background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0)); /* Fade effect */
    }
    #bottom-gallery .swiper-container {
      width: 100%;
      height: 100%;
    }
    #bottom-gallery .swiper-slide {
      width: 280px; /* Wider slides */
      height: 160px; /* Adjusted height */
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.5s ease-out; /* Smoother transition */
      transform-style: preserve-3d;
      /* Default state: less visible */
      opacity: 0.35;
      filter: blur(3px);
      transform: scale(0.8);
    }
    /* Active slide: fully visible, no blur, full size */
    #bottom-gallery .swiper-slide-active {
      opacity: 1;
      filter: blur(0px);
      transform: scale(1);
      z-index: 1; /* Ensure active is on top */
    }
    /* Adjacent slides: slightly more visible */
    #bottom-gallery .swiper-slide-prev,
    #bottom-gallery .swiper-slide-next {
      opacity: 0.7;
      filter: blur(1px);
      transform: scale(0.9);
    }
    #bottom-gallery .swiper-slide img {
      display: block;
      width: 100%; /* Fill slide width */
      height: 100%; /* Fill slide height */
      object-fit: cover; /* Cover area, crop if needed */
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.4); /* Stronger shadow */
    }

    /* --- Logo --- */
    #logo {
      position: fixed;
      bottom: 200px; /* Position above gallery+legend */
      left: 15px;
      width: 130px; /* Slightly larger */
      opacity: 0.9;
      z-index: 10; /* Above most elements */
      transition: opacity 0.3s ease;
    }
    #logo:hover {
        opacity: 1;
    }

    /* --- Legend --- */
    #legend-container {
      position: fixed;
      right: 15px;
      bottom: 200px; /* Position above gallery */
      background: rgba(0, 0, 0, 0.85); /* Slightly darker background */
      padding: 10px 15px;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap; /* Allow items to wrap */
      gap: 10px 15px; /* Row and column gap */
      z-index: 10; /* Above most elements */
      max-width: calc(100% - 180px); /* Max width relative to logo/screen edge */
       /* Removed the transform: scale(1.5) - can be added back if desired */
    }

    .legend-item {
      display: flex;
      align-items: center;
      font-size: 0.85rem; /* Slightly larger legend text */
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      white-space: nowrap; /* Prevent brand names from wrapping */
    }

    .legend-color {
      width: 12px; /* Larger color swatch */
      height: 12px;
      display: inline-block;
      margin-right: 6px; /* More space */
      border-radius: 3px;
      border: 1px solid rgba(255, 255, 255, 0.6); /* More visible border */
      flex-shrink: 0; /* Prevent swatch from shrinking */
    }

    /* --- Custom Scrollbar (Webkit) --- */
    body::-webkit-scrollbar {
      width: 10px;
    }
    body::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    body::-webkit-scrollbar-thumb {
      background-color: rgba(255, 165, 0, 0.6); /* Semi-transparent orange */
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    body::-webkit-scrollbar-thumb:hover {
      background-color: rgba(255, 165, 0, 0.85); /* More opaque on hover */
    }

    /* --- Loading/Error Message --- */
    .status-message {
        width: 100%;
        text-align: center;
        padding: 4rem 0;
        font-size: 1.2rem;
        color: #ccc;
    }
    .error-message {
        color: #ff6b6b; /* Reddish color for errors */
        font-weight: bold;
    }
    .error-message small {
        display: block;
        font-size: 0.9rem;
        color: #ffaaaa;
        margin-top: 0.5rem;
        font-weight: normal;
    }

  </style>
</head>
<body>
  <!-- Video Background -->
  <video autoplay muted loop id="video-bg">
    <source src="video.mp4" type="video/mp4">
    Tarayıcınız video etiketini desteklemiyor.
  </video>

  <!-- Menu Container -->
  <div id="menu">
    <div class="status-message">Menü yükleniyor...</div>
  </div>

  <!-- Bottom Image Gallery -->
  <div id="bottom-gallery">
    <div class="swiper-container gallery-swiper">
      <div class="swiper-wrapper">
        <!-- Gallery images -->
        <div class="swiper-slide"><img src="joints.png" alt="Joints"></div>
        <div class="swiper-slide"><img src="rainbow_zizi.png" alt="Rainbow Zizi"></div>
        <div class="swiper-slide"><img src="hash_1.png" alt="Hash 1"></div>
        <div class="swiper-slide"><img src="zowahh.png" alt="Zowahh"></div>
        <div class="swiper-slide"><img src="gelato41.png" alt="Gelato 41"></div>
        <div class="swiper-slide"><img src="hash_2.png" alt="Hash 2"></div>
        <div class="swiper-slide"><img src="fritter_licker.png" alt="Fritter Licker"></div>
        <div class="swiper-slide"><img src="exodus_cheese.png" alt="Exodus Cheese"></div>
        <div class="swiper-slide"><img src="hash_3.png" alt="Hash 3"></div>
        <div class="swiper-slide"><img src="exodus_cheese_joints.png" alt="Exodus Cheese Joints"></div>
        <div class="swiper-slide"><img src="aardactig_bio_amnesia.png" alt="Aardachtig Bio Amnesia"></div>
        <!-- Add more slides as needed -->
      </div>
    </div>
  </div>

  <!-- Legend Container -->
  <div id="legend-container"></div>

  <!-- Logo -->
  <img id="logo" src="Pasja Review_1.png" alt="Pasja Logo">

  <!-- Swiper JS -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <!-- Custom Menu Script -->
  <script>
    // --- Configuration ---
    const CHECK_INTERVAL = 60000; // Check for updates every 60 seconds (1 minute)
    const BASE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz3L-IeqXSMxpJPMO_hmdZtSRFz8VY2dzYbq4RfXtHsrNAZ_VbhK219hRJtdDq3BWvH/exec';
    const MENU_URL = BASE_SCRIPT_URL;
    const RENK_URL = BASE_SCRIPT_URL + '?action=renkler'; // URL for brand colors
    const SIRA_URL = BASE_SCRIPT_URL + '?action=sirala';   // URL for category sorting
    const VERSION_URL = BASE_SCRIPT_URL + '?action=version'; // URL for data version

    // --- State ---
    let currentDataVersion = null;
    let swiperInstance = null; // To hold the Swiper instance

    // --- Helper Functions ---
    /**
     * Fetches JSON data from a given URL.
     * @param {string} url - The URL to fetch data from.
     * @returns {Promise<object>} - A promise that resolves with the JSON data.
     * @throws {Error} - Throws an error if the fetch fails or the response is not ok.
     */
    async function fetchData(url) {
      try {
        const response = await fetch(url, { cache: "no-store" }); // Prevent caching issues
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status} for ${url}`);
        }
        return await response.json();
      } catch (error) {
        console.error("Fetch error:", error);
        // Rethrow the error so it can be caught by the calling function
        throw error;
      }
    }

    /**
     * Creates and renders the menu HTML structure from fetched data.
     * @param {boolean} [isUpdate=false] - Flag indicating if this is an update or initial load.
     */
    async function createMenu(isUpdate = false) {
      const menuContainer = document.getElementById('menu');
      const legendContainer = document.getElementById('legend-container');

      // Show loading message only on initial load
      if (!isUpdate) {
        menuContainer.innerHTML = '<div class="status-message">Menü yükleniyor...</div>';
        legendContainer.innerHTML = ''; // Clear legend on initial load
      }

      try {
        // Fetch all required data concurrently
        const [menuData, renklerData, siralamaData, versionData] = await Promise.all([
          fetchData(MENU_URL),
          fetchData(RENK_URL),
          fetchData(SIRA_URL),
          fetchData(VERSION_URL)
        ]);

        // Check if the version has actually changed (relevant for updates)
        if (isUpdate && versionData.version === currentDataVersion) {
          console.log("Data version hasn't changed. No UI update needed.");
          return; // Exit if data is the same
        }

        currentDataVersion = versionData.version; // Update the current version

        // --- Data Processing ---
        const kategoriler = {}; // { categoryName: [item1, item2, ...] }
        const tumMarkalar = new Set(); // Unique brand names
        const renklerMap = renklerData.reduce((acc, item) => { // Convert array to { brand: color } map
            acc[item.marka] = item.renk_kodu;
            return acc;
            }, {});

        // Initialize categories based on sorting data to maintain order
        siralamaData.forEach(k => {
          if (!kategoriler[k.kategori]) { // Ensure category exists
            kategoriler[k.kategori] = [];
          }
        });

        // Populate categories with menu items and collect brands
        menuData.forEach(item => {
          // Ensure the item's category exists in our sorting data
          if (kategoriler.hasOwnProperty(item.ana_kategori)) {
            kategoriler[item.ana_kategori].push(item);
            if (item.marka) { // Add brand if it exists
              tumMarkalar.add(item.marka);
            }
          } else {
             console.warn(`Item "${item.urun_adi}" has category "${item.ana_kategori}" which is not defined in sorting data. Skipping.`);
          }
        });

        // Group categories by column number defined in sorting data
        const sutunGruplari = {}; // { columnNumber: [{kategori: 'Name', sira_no: 1}, ...] }
        siralamaData.forEach(k => {
          const colNum = k.sutun_no;
          if (!sutunGruplari[colNum]) {
            sutunGruplari[colNum] = [];
          }
          // Add category and its sort order within the column
          sutunGruplari[colNum].push({ kategori: k.kategori, sira_no: k.sira_no });
        });

        // --- Rendering ---
        menuContainer.innerHTML = ''; // Clear previous content or loading message

        // Sort columns by their number and create column elements
        Object.keys(sutunGruplari).sort((a, b) => parseInt(a) - parseInt(b)).forEach(colNum => {
          const columnDiv = document.createElement('div');
          columnDiv.className = 'column';

          // Sort categories within the column based on their 'sira_no'
          const sortedKategorilerInColumn = sutunGruplari[colNum].sort((a, b) => a.sira_no - b.sira_no);

          // Render each category in the column
          sortedKategorilerInColumn.forEach(({ kategori: kategoriAdi }) => {
            // Category Title
            const baslikDiv = document.createElement('div');
            baslikDiv.className = 'kategori-baslik';
            baslikDiv.textContent = kategoriAdi;
            columnDiv.appendChild(baslikDiv);

            // Header Row
            const headerDiv = document.createElement('div');
            headerDiv.className = 'header-row';

            // *** CHANGED: Determine header text for the two price columns ***
            let priceHeader1 = '1 GR';
            let priceHeader2 = '5 GR';
            const upperCaseKategori = kategoriAdi.toUpperCase();

            if (upperCaseKategori === 'JOINTS') {
                priceHeader1 = '1 AD'; // AD = Adet (Piece)
                priceHeader2 = '5 AD';
            } else if (upperCaseKategori === 'EDIBLES' || upperCaseKategori === 'DRINKS') {
                priceHeader1 = 'Fiyat'; // Fiyat = Price
                priceHeader2 = ''; // Leave second header empty
            }
            // Set header content with 4 spans
            headerDiv.innerHTML = `<span>Ürün</span><span>THC</span><span>${priceHeader1}</span><span>${priceHeader2}</span>`;
            columnDiv.appendChild(headerDiv);

            // Products in the category
            const itemsInCategory = kategoriler[kategoriAdi] || [];
            if (itemsInCategory.length > 0) {
              itemsInCategory.forEach(urun => {
                const urunDiv = document.createElement('div');
                let itemClasses = 'urun';
                if (urun.stok_var_mi === false) { // Check if out of stock
                  itemClasses += ' cizili';
                }
                if (urun.yeni_mi === true) { // Check if new
                  itemClasses += ' new';
                }
                urunDiv.className = itemClasses;

                const thcText = urun.thc_orani ? `${urun.thc_orani}%` : '-'; // Add % to THC
                const markaRenk = renklerMap[urun.marka] || 'white'; // Get color or default to white

                // *** CHANGED: Format price text for two separate columns ***
                let price1Text = `${urun.fiyat_1gr || '-'}€`;
                let price2Text = `${urun.fiyat_5gr || '-'}€`;

                // For Edibles/Drinks, show price in first column, '-' in second
                if (upperCaseKategori === 'EDIBLES' || upperCaseKategori === 'DRINKS') {
                    price2Text = '-';
                }

                // Set product row content with 4 spans
                urunDiv.innerHTML = `
                  <span style="color:${markaRenk};">${urun.urun_adi || 'İsimsiz Ürün'}</span>
                  <span class="thc-orani">${thcText}</span>
                  <span>${price1Text}</span>
                  <span>${price2Text}</span>
                `;
                columnDiv.appendChild(urunDiv);
              });
            } else {
              // Show message if category is empty
              const yakindaDiv = document.createElement('div');
              yakindaDiv.className = 'yakinda-mesaji';
              yakindaDiv.textContent = 'Yakında...';
              columnDiv.appendChild(yakindaDiv);
            }
          });
          // Add the completed column to the menu container
          menuContainer.appendChild(columnDiv);
        });

        // --- Render Legend ---
        // Render legend only on initial load or if it was previously empty
        if (!isUpdate || legendContainer.innerHTML.trim() === '') {
            legendContainer.innerHTML = ''; // Clear it just in case
            const sortedMarkalar = Array.from(tumMarkalar).sort((a, b) => a.localeCompare(b)); // Sort brands alphabetically

            sortedMarkalar.forEach(marka => {
                const legendItemDiv = document.createElement('div');
                legendItemDiv.className = 'legend-item';
                const renk = renklerMap[marka] || '#CCCCCC'; // Default grey color for unknown brands
                legendItemDiv.innerHTML = `
                <span class="legend-color" style="background-color:${renk};"></span>
                ${marka}
                `;
                legendContainer.appendChild(legendItemDiv);
            });
        }

      } catch (error) {
        console.error('Menü oluşturulamadı:', error);
        // Display a user-friendly error message
        menuContainer.innerHTML = `
          <div class="status-message error-message">
            Menü yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyin.
            <small>Hata Detayı: ${error.message}</small>
          </div>`;
        currentDataVersion = null; // Reset version on error to force reload on next check
      }
    }

    /**
     * Checks if the data version on the server has changed and triggers an update if needed.
     */
    async function checkForUpdates() {
      // Don't check if the initial load failed (currentDataVersion is null)
      if (currentDataVersion === null) {
        console.log("Initial load failed or not complete, skipping update check.");
        // Optionally, try to load again if initial load failed
        // await createMenu();
        return;
      }

      console.log("Checking for updates...");
      try {
        const versionData = await fetchData(VERSION_URL);
        if (versionData.version && versionData.version !== currentDataVersion) {
          console.log(`New data version detected (${versionData.version}). Updating menu...`);
          await createMenu(true); // Pass true to indicate it's an update
        } else {
          console.log("Data is up-to-date.");
        }
      } catch (error) {
        // Log error but don't necessarily show a disruptive message to the user
        console.error("Güncelleme kontrolünde hata:", error);
      }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize Swiper Gallery
      swiperInstance = new Swiper('.gallery-swiper', {
        effect: 'slide',         // Basic slide effect
        grabCursor: false,       // No grab cursor, assumes display only
        centeredSlides: true,    // Center the active slide
        slidesPerView: 'auto',   // Show as many slides as fit based on their width
        loop: true,              // Loop the slides
        spaceBetween: 15,        // Space between slides
        autoplay: {
          delay: 3000,           // Autoplay delay
          disableOnInteraction: false, // Autoplay continues even if user interacts (if allowTouchMove was true)
          pauseOnMouseEnter: true,   // Pause autoplay when mouse is over the gallery
        },
        allowTouchMove: false,   // Disable manual dragging (for display purposes)
        speed: 600,              // Transition speed
      });

      // Initial Menu Load
      createMenu().then(() => {
        // Start checking for updates only after the initial load attempt
        // Check immediately once, then set interval
        setTimeout(checkForUpdates, 5000); // Check shortly after load
        setInterval(checkForUpdates, CHECK_INTERVAL);
      }).catch(err => {
          console.error("Initial menu load promise rejected:", err);
          // Error is already displayed by createMenu, but log it here too.
      });
    });

  </script>
</body>
</html>
